name: æ„å»ºã€PRä¸å‘å¸ƒ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenList Moe ç‰ˆæœ¬ æ ¼å¼: v1.0.0'
        required: true
        type: string
      op_version:
        description: 'OpenList ç‰ˆæœ¬ æ ¼å¼: v1.0.0'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    env:
      MOE_VERSION: ${{ github.event.inputs.version }}
      OP_VERSION: ${{ github.event.inputs.op_version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: æ‰§è¡Œæ„å»º
        run: npm run ci
        env:
          MOE_VERSION: ${{ env.MOE_VERSION }}
          OP_VERSION: ${{ env.OP_VERSION }}

      - name: åˆ›å»ºæ„å»ºåˆ†æ”¯å¹¶æäº¤
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "build/dist-${{ github.event.inputs.version }}"
          git add dist/
          git commit -m "ğŸ—ï¸ build(dist): ${{ github.event.inputs.version }}"
          git push origin "build/dist-${{ github.event.inputs.version }}"

      - name: åˆ›å»ºPull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç›´æ¥åˆ›å»ºPRå¹¶å…³è”ä»“åº“ä¸­å·²å­˜åœ¨çš„æ ‡ç­¾
          gh pr create \
            --base main \
            --head "build/dist-${{ github.event.inputs.version }}" \
            --title "ğŸ—ï¸ build(dist): ${{ github.event.inputs.version }}" \
            --body "## ğŸš€ CIæ„å»º
            æ­¤ Pull Request ç”±å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å« **${{ github.event.inputs.version }}** ç‰ˆæœ¬çš„ç”Ÿäº§æ„å»ºäº§ç‰©ã€‚
            
            ### ğŸ“‹ æ„å»º
            | é¡¹ç›® | è¯¦æƒ… |
            |------|------|
            | **Moeç‰ˆæœ¬** | ${{ github.event.inputs.version }} |
            | **OpenListç‰ˆæœ¬** | ${{ github.event.inputs.op_version }} |
            | **æ„å»ºåˆ†æ”¯** | \`build/dist-${{ github.event.inputs.version }}\` |
            | **æ„å»ºæ—¶é—´** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
            | **æäº¤å“ˆå¸Œ** | \`$(git rev-parse HEAD)\` |
            
            ### ğŸ“ æ–‡ä»¶
            æœ¬æ¬¡æäº¤æ›´æ–°äº† \`dist/\` ç›®å½•ä¸‹çš„ç”Ÿäº§æ–‡ä»¶ï¼š
            - \`dist/css/OpenList-Moe.min.css\`
            - \`dist/js/OpenList-Moe.min.js\`
            
            ### âœ… æ¸…å•
            - [ ] ç¡®è®¤ç‰ˆæœ¬å·æ­£ç¡®
            - [ ] ç¡®è®¤æ ·å¼ç¬¦åˆé¢„æœŸ" \
            --label "ci-release,automated-pr"

      - name: å‡†å¤‡å‘å¸ƒäº§ç‰©
        run: |
          mkdir -p release-artifacts
          tar -czf "release-artifacts/OpenList-Moe-${{ github.event.inputs.version }}.tar.gz" dist/
          zip -r "release-artifacts/OpenList-Moe-${{ github.event.inputs.version }}.zip" dist/

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ github.event.inputs.version }}
          path: |
            dist/
            release-artifacts/

  create-draft-release:
    needs: build-and-pr
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: release-assets-${{ github.event.inputs.version }}
          path: artifacts/

      - name: åˆ›å»ºè‰ç¨¿ Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_OWNER_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          name: "ğŸ‰ ${{ env.VERSION }} (å¾…å‘å¸ƒ)"
          draft: true
          prerelease: false
          target_commitish: "build/dist-${{ github.event.inputs.version }}"
          body: |
            **è¿™æ˜¯ä¸€ä¸ªå·¥ä½œæµè‡ªåŠ¨åˆ›å»ºçš„å‘è¡Œç‰ˆè‰ç¨¿ã€‚**
            
            - **ç‰ˆæœ¬**: ${{ env.VERSION }}
            - **æ¥æºåˆ†æ”¯**: build/dist-${{ env.VERSION }}
            - **åŒ…å«æ–‡ä»¶**: æœ€å°åŒ–çš„ CSSã€JS æ–‡ä»¶åŠå®Œæ•´å‹ç¼©åŒ…ã€‚
            
            **è¯·åœ¨å‘å¸ƒå‰ï¼š**
            1.  æµ‹è¯•å¹¶åˆå¹¶æ„å»ºåˆ†æ”¯ã€‚
            2.  æ ¸å¯¹æ„å»ºæ–‡ä»¶ã€‚
            3.  è¡¥å……å®Œæ•´çš„å˜æ›´æ—¥å¿—ã€‚
            4.  ç‚¹å‡» "Publish release"ã€‚
          files: |
            artifacts/dist/css/OpenList-Moe.min.css
            artifacts/dist/js/OpenList-Moe.min.js
            artifacts/release-artifacts/OpenList-Moe-${{ env.VERSION }}.tar.gz
            artifacts/release-artifacts/OpenList-Moe-${{ env.VERSION }}.zip